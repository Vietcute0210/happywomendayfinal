<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>L·ªùi ch√∫c 3D</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: radial-gradient(
          ellipse at center,
          #000011 0%,
          #000000 100%
        );
        font-family: "Times New Roman", Times, serif;
        user-select: none;
        perspective: 1000px;
        cursor: pointer;
      }
      #galaxy,
      #rotatingContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }
      /* Allow the rotating container to receive pointer events so we can drag */
      #rotatingContainer {
        z-index: 2;
        top: 50%;
        left: 50%;
        transform-style: preserve-3d;
        transform-origin: center center;
        transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg);
        /* pointer-events default (auto) allows pointerdown/drag */
      }
      .text-particle,
      .image-particle {
        position: absolute;
        will-change: transform, opacity;
        user-select: none;
        pointer-events: none;
      }
      .text-particle {
        white-space: nowrap;
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
        color: #ff7487;
      }
      .image-particle {
        /* Increase the maximum dimensions of image particles further so they
         appear more prominent in the 3D message space. A larger size of
         approximately 140px makes the photos easier to see while still
         fitting comfortably in the 3D environment. */
        max-width: 140px;
        max-height: 140px;
        border-radius: 8px;
        filter: drop-shadow(0 0 5px #fff);
      }
    </style>
  </head>
  <body>
    <div id="galaxy"></div>
    <div id="rotatingContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script>
      // Retrieve customization from window.name or localStorage
      function getCustom() {
        try {
          if (window.name) {
            const obj = JSON.parse(window.name);
            return obj || {};
          }
        } catch {}
        try {
          const raw = localStorage.getItem("customization");
          if (raw) {
            return JSON.parse(raw);
          }
        } catch {}
        return {};
      }
      const custom = getCustom();

      // Provide a default list of images/GIFs if customization does not specify any
      const defaultImages = [
        "giftbox.png",
        "heartAnimation.gif",
        "mewmew.gif",
        "9313a43c-9a60-4469-ac4f-6d841d24e9a7.png",
        "35da2b21-3388-4959-af82-f97a0b2b15e7.png",
        "015b3851-f504-4ebe-9c62-d0970e8e1fa3.png",
        "ee27448f-01b1-4252-8f45-d054a6763a49.png",
      ];

      // Determine messages and images from customization
      const messages =
        Array.isArray(custom.messages) && custom.messages.length
          ? custom.messages
          : ["You are my sunshine üåü", "Always be happy", "With love"];
      const imageURLs =
        Array.isArray(custom.imgs) && custom.imgs.length
          ? custom.imgs
          : defaultImages;

      // Icons (hearts)
      const icons = ["‚ù§Ô∏è", "üíó", "üíï"];
      const imageIcons = [
        "giftbox.png",
        "heartAnimation.gif",
        "mewmew.gif",
        "be6672ed-5fd6-42ac-98fb-2f902345cbd9.png",
        "9313a43c-9a60-4469-ac4f-6d841d24e9a7.png",
        "35da2b21-3388-4959-af82-f97a0b2b15e7.png",
        "015b3851-f504-4ebe-9c62-d0970e8e1fa3.png",
        "ee27448f-01b1-4252-8f45-d054a6763a49.png",
      ];

      const maxParticles = 120;
      const activeParticles = new Set();

      const rotatingContainer = document.getElementById("rotatingContainer");
      const galaxy = document.getElementById("galaxy");

      function createParticle(type = "text") {
        if (activeParticles.size >= maxParticles) return;
        const el =
          type === "text"
            ? document.createElement("div")
            : document.createElement("img");
        if (type === "text") {
          const isIcon = Math.random() < 0.3;
          el.className = "text-particle";
          if (isIcon) {
            // ch·ªçn emoji ho·∫∑c ·∫£nh ng·∫´u nhi√™n
            if (Math.random() < 0.5) {
              // emoji
              el.textContent = icons[Math.floor(Math.random() * icons.length)];
              el.style.fontSize = 20 + Math.random() * 10 + "px";
            } else {
              // ·∫£nh icon
              const img = document.createElement("img");
              img.src =
                imageIcons[Math.floor(Math.random() * imageIcons.length)];
              img.className = "image-particle";
              el.appendChild(img);
            }
          } else {
            el.textContent =
              messages[Math.floor(Math.random() * messages.length)];
            el.style.fontSize = 18 + Math.random() * 10 + "px";
          }
        } else {
          if (imageURLs.length === 0) return;
          el.className = "image-particle";
          el.src = imageURLs[Math.floor(Math.random() * imageURLs.length)];
        }
        el.style.opacity = 0;
        rotatingContainer.appendChild(el);
        const w = el.offsetWidth || 40;
        el.style.left = Math.random() * (window.innerWidth - w) + "px";
        const z = -Math.random() * 300;
        const startY = -50;
        const endY = window.innerHeight + 50;
        const duration = 7000 + Math.random() * 4000;
        const t0 = performance.now();
        function animate(t) {
          const p = (t - t0) / duration;
          if (p >= 1) {
            el.remove();
            activeParticles.delete(el);
          } else {
            const y = startY + p * (endY - startY);
            const op = p < 0.1 ? p * 10 : p > 0.9 ? (1 - p) * 10 : 1;
            el.style.opacity = op;
            el.style.transform = `translate3d(0, ${y}px, ${z}px)`;
            requestAnimationFrame(animate);
          }
        }
        activeParticles.add(el);
        requestAnimationFrame(animate);
      }

      function loopParticles() {
        let last = 0;
        function tick(t) {
          if (t - last > 300) {
            createParticle("text");
            if (Math.random() < 0.5) createParticle("image");
            last = t;
          }
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      function startStars() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 150;
        const renderer = new THREE.WebGLRenderer({
          alpha: true,
          antialias: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0);
        galaxy.appendChild(renderer.domElement);
        const starsCount = 500;
        const positions = new Float32Array(starsCount * 3);
        for (let i = 0; i < starsCount; i++) {
          positions[i * 3] = (Math.random() - 0.5) * 400;
          positions[i * 3 + 1] = (Math.random() - 0.5) * 400;
          positions[i * 3 + 2] = (Math.random() - 0.5) * 400;
        }
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );
        const starTexture = new THREE.TextureLoader().load(
          "https://threejs.org/examples/textures/sprites/disc.png"
        );
        const material = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 0.5,
          map: starTexture,
          transparent: true,
          alphaTest: 0.2,
          depthWrite: false,
        });
        const stars = new THREE.Points(geometry, material);
        scene.add(stars);
        function animate() {
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        }
        animate();
        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      }

      // Replace initRotation with pointer-drag based rotation that accumulates
      function initRotation() {
        let pointerDown = false;
        let lastX = 0,
          lastY = 0;
        let rotX = 0,
          rotY = 0;
        function setRotation(dx, dy) {
          rotY += dx * 0.3; // adjust sensitivity as needed
          rotX -= dy * 0.3;
          // Optional: clamp rotX to avoid flipping completely
          rotX = Math.max(Math.min(rotX, 90), -90);
          rotatingContainer.style.transform = `translate(-50%, -50%) rotateX(${rotX}deg) rotateY(${rotY}deg)`;
        }
        function onPointerDown(e) {
          pointerDown = true;
          lastX = e.clientX;
          lastY = e.clientY;
        }
        function onPointerMove(e) {
          if (!pointerDown) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          setRotation(dx, dy);
          lastX = e.clientX;
          lastY = e.clientY;
        }
        function onPointerUp() {
          pointerDown = false;
        }
        rotatingContainer.addEventListener("pointerdown", onPointerDown);
        window.addEventListener("pointermove", onPointerMove);
        window.addEventListener("pointerup", onPointerUp);
        // Prevent default dragging on images inside the container
        document.querySelectorAll("img").forEach((img) => {
          img.addEventListener("dragstart", (e) => e.preventDefault());
        });
      }

      // Setup music with default fallback and infinite loop
      function setupMusic() {
        let audio;
        if (custom.audio) {
          audio = new Audio(custom.audio);
        } else {
          // Default audio file name ‚Äì replace with your own file name (placed in same directory)
          audio = new Audio("your_song.mp3");
        }
        // Resume from stored time if available
        if (typeof custom.audioTime === "number" && !isNaN(custom.audioTime)) {
          audio.currentTime = custom.audioTime;
        }
        audio.loop = true;
        audio.play().catch(() => {});
      }

      window.addEventListener("DOMContentLoaded", () => {
        startStars();
        loopParticles();
        initRotation();
        setupMusic();
      });
    </script>
  </body>
</html>
